# OSTime.c
.include "macros.inc"

.section .text, "ax"

.balign 4

glabel OSGetTime
/* 0A877C 800ADD1C 7C6D42E6 */  mftbu   r3
/* 0A8780 800ADD20 7C8C42E6 */  mftb    r4, 0x10c
/* 0A8784 800ADD24 7CAD42E6 */  mftbu   r5
/* 0A8788 800ADD28 7C032800 */  cmpw    r3, r5
/* 0A878C 800ADD2C 4082FFF0 */  bne     OSGetTime
/* 0A8790 800ADD30 4E800020 */  blr     

glabel OSGetTick
/* 0A8794 800ADD34 7C6C42E6 */  mftb    r3, 0x10c
/* 0A8798 800ADD38 4E800020 */  blr     

glabel __OSGetSystemTime
/* 0A879C 800ADD3C 7C0802A6 */  mflr    r0
/* 0A87A0 800ADD40 90010004 */  stw     r0, 4(r1)
/* 0A87A4 800ADD44 9421FFE0 */  stwu    r1, -0x20(r1)
/* 0A87A8 800ADD48 93E1001C */  stw     r31, 0x1c(r1)
/* 0A87AC 800ADD4C 93C10018 */  stw     r30, 0x18(r1)
/* 0A87B0 800ADD50 93A10014 */  stw     r29, 0x14(r1)
/* 0A87B4 800ADD54 4BFFCA1D */  bl      OSDisableInterrupts
/* 0A87B8 800ADD58 7C7F1B78 */  mr      r31, r3
/* 0A87BC 800ADD5C 4BFFFFC1 */  bl      OSGetTime
/* 0A87C0 800ADD60 3CC08000 */  lis     r6, 0x8000
/* 0A87C4 800ADD64 80A630DC */  lwz     r5, 0x30dc(r6)
/* 0A87C8 800ADD68 800630D8 */  lwz     r0, 0x30d8(r6)
/* 0A87CC 800ADD6C 7FA52014 */  addc    r29, r5, r4
/* 0A87D0 800ADD70 7FC01914 */  adde    r30, r0, r3
/* 0A87D4 800ADD74 7FE3FB78 */  mr      r3, r31
/* 0A87D8 800ADD78 4BFFCA21 */  bl      OSRestoreInterrupts
/* 0A87DC 800ADD7C 7FA4EB78 */  mr      r4, r29
/* 0A87E0 800ADD80 7FC3F378 */  mr      r3, r30
/* 0A87E4 800ADD84 80010024 */  lwz     r0, 0x24(r1)
/* 0A87E8 800ADD88 83E1001C */  lwz     r31, 0x1c(r1)
/* 0A87EC 800ADD8C 83C10018 */  lwz     r30, 0x18(r1)
/* 0A87F0 800ADD90 83A10014 */  lwz     r29, 0x14(r1)
/* 0A87F4 800ADD94 38210020 */  addi    r1, r1, 0x20
/* 0A87F8 800ADD98 7C0803A6 */  mtlr    r0
/* 0A87FC 800ADD9C 4E800020 */  blr     

GetDates:
/* 0A8800 800ADDA0 3CA09249 */  lis     r5, 0x9249
/* 0A8804 800ADDA4 38052493 */  addi    r0, r5, 0x2493
/* 0A8808 800ADDA8 38E30006 */  addi    r7, r3, 6
/* 0A880C 800ADDAC 7CC03896 */  mulhw   r6, r0, r7
/* 0A8810 800ADDB0 3CA0B38D */  lis     r5, 0xb38d
/* 0A8814 800ADDB4 3805F9B1 */  addi    r0, r5, -1615
/* 0A8818 800ADDB8 7C001896 */  mulhw   r0, r0, r3
/* 0A881C 800ADDBC 7CA63A14 */  add     r5, r6, r7
/* 0A8820 800ADDC0 7CA51670 */  srawi   r5, r5, 2
/* 0A8824 800ADDC4 54A60FFE */  srwi    r6, r5, 0x1f
/* 0A8828 800ADDC8 7CA53214 */  add     r5, r5, r6
/* 0A882C 800ADDCC 7C001A14 */  add     r0, r0, r3
/* 0A8830 800ADDD0 1CC50007 */  mulli   r6, r5, 7
/* 0A8834 800ADDD4 7C004670 */  srawi   r0, r0, 8
/* 0A8838 800ADDD8 54050FFE */  srwi    r5, r0, 0x1f
/* 0A883C 800ADDDC 7CA02A14 */  add     r5, r0, r5
/* 0A8840 800ADDE0 7C063850 */  subf    r0, r6, r7
/* 0A8844 800ADDE4 1D65016D */  mulli   r11, r5, 0x16d
/* 0A8848 800ADDE8 90040018 */  stw     r0, 0x18(r4)
/* 0A884C 800ADDEC 48000004 */  b       lbl_800ADDF0
lbl_800ADDF0:
/* 0A8850 800ADDF0 3CC051EC */  lis     r6, 0x51ec
/* 0A8854 800ADDF4 3946851F */  addi    r10, r6, -31457
/* 0A8858 800ADDF8 48000004 */  b       lbl_800ADDFC
lbl_800ADDFC:
/* 0A885C 800ADDFC 4800000C */  b       lbl_800ADE08
lbl_800ADE00:
/* 0A8860 800ADE00 396BFE93 */  addi    r11, r11, -365
/* 0A8864 800ADE04 38A5FFFF */  addi    r5, r5, -1
lbl_800ADE08:
/* 0A8868 800ADE08 2C050001 */  cmpwi   r5, 1
/* 0A886C 800ADE0C 4080000C */  bge     lbl_800ADE18
/* 0A8870 800ADE10 38000000 */  li      r0, 0
/* 0A8874 800ADE14 48000038 */  b       lbl_800ADE4C
lbl_800ADE18:
/* 0A8878 800ADE18 3805FFFF */  addi    r0, r5, -1
/* 0A887C 800ADE1C 7C0A0096 */  mulhw   r0, r10, r0
/* 0A8880 800ADE20 7C083E70 */  srawi   r8, r0, 7
/* 0A8884 800ADE24 7C062E70 */  srawi   r6, r0, 5
/* 0A8888 800ADE28 38050003 */  addi    r0, r5, 3
/* 0A888C 800ADE2C 54C70FFE */  srwi    r7, r6, 0x1f
/* 0A8890 800ADE30 7C001670 */  srawi   r0, r0, 2
/* 0A8894 800ADE34 55090FFE */  srwi    r9, r8, 0x1f
/* 0A8898 800ADE38 7CC63A14 */  add     r6, r6, r7
/* 0A889C 800ADE3C 7C000194 */  addze   r0, r0
/* 0A88A0 800ADE40 7CE84A14 */  add     r7, r8, r9
/* 0A88A4 800ADE44 7C060050 */  subf    r0, r6, r0
/* 0A88A8 800ADE48 7C070214 */  add     r0, r7, r0
lbl_800ADE4C:
/* 0A88AC 800ADE4C 7C0B0214 */  add     r0, r11, r0
/* 0A88B0 800ADE50 7C030000 */  cmpw    r3, r0
/* 0A88B4 800ADE54 4180FFAC */  blt     lbl_800ADE00
/* 0A88B8 800ADE58 7CA61670 */  srawi   r6, r5, 2
/* 0A88BC 800ADE5C 90A40014 */  stw     r5, 0x14(r4)
/* 0A88C0 800ADE60 7CC60194 */  addze   r6, r6
/* 0A88C4 800ADE64 54C6103A */  slwi    r6, r6, 2
/* 0A88C8 800ADE68 7CC62810 */  subfc   r6, r6, r5
/* 0A88CC 800ADE6C 7C001850 */  subf    r0, r0, r3
/* 0A88D0 800ADE70 2C060000 */  cmpwi   r6, 0
/* 0A88D4 800ADE74 9004001C */  stw     r0, 0x1c(r4)
/* 0A88D8 800ADE78 38E00001 */  li      r7, 1
/* 0A88DC 800ADE7C 39000000 */  li      r8, 0
/* 0A88E0 800ADE80 40820030 */  bne     lbl_800ADEB0
/* 0A88E4 800ADE84 3C6051EC */  lis     r3, 0x51ec
/* 0A88E8 800ADE88 3863851F */  addi    r3, r3, -31457
/* 0A88EC 800ADE8C 7C632896 */  mulhw   r3, r3, r5
/* 0A88F0 800ADE90 7C632E70 */  srawi   r3, r3, 5
/* 0A88F4 800ADE94 54660FFE */  srwi    r6, r3, 0x1f
/* 0A88F8 800ADE98 7C633214 */  add     r3, r3, r6
/* 0A88FC 800ADE9C 1C630064 */  mulli   r3, r3, 0x64
/* 0A8900 800ADEA0 7C632850 */  subf    r3, r3, r5
/* 0A8904 800ADEA4 2C030000 */  cmpwi   r3, 0
/* 0A8908 800ADEA8 41820008 */  beq     lbl_800ADEB0
/* 0A890C 800ADEAC 7CE83B78 */  mr      r8, r7
lbl_800ADEB0:
/* 0A8910 800ADEB0 2C080000 */  cmpwi   r8, 0
/* 0A8914 800ADEB4 40820030 */  bne     lbl_800ADEE4
/* 0A8918 800ADEB8 3C6051EC */  lis     r3, 0x51ec
/* 0A891C 800ADEBC 3863851F */  addi    r3, r3, -31457
/* 0A8920 800ADEC0 7C632896 */  mulhw   r3, r3, r5
/* 0A8924 800ADEC4 7C633E70 */  srawi   r3, r3, 7
/* 0A8928 800ADEC8 54660FFE */  srwi    r6, r3, 0x1f
/* 0A892C 800ADECC 7C633214 */  add     r3, r3, r6
/* 0A8930 800ADED0 1C630190 */  mulli   r3, r3, 0x190
/* 0A8934 800ADED4 7C632850 */  subf    r3, r3, r5
/* 0A8938 800ADED8 2C030000 */  cmpwi   r3, 0
/* 0A893C 800ADEDC 41820008 */  beq     lbl_800ADEE4
/* 0A8940 800ADEE0 38E00000 */  li      r7, 0
lbl_800ADEE4:
/* 0A8944 800ADEE4 2C070000 */  cmpwi   r7, 0
/* 0A8948 800ADEE8 41820010 */  beq     lbl_800ADEF8
/* 0A894C 800ADEEC 3C608010 */  lis     r3, LeapYearDays@ha
/* 0A8950 800ADEF0 38C3F430 */  addi    r6, r3, LeapYearDays@l
/* 0A8954 800ADEF4 4800000C */  b       lbl_800ADF00
lbl_800ADEF8:
/* 0A8958 800ADEF8 3C608010 */  lis     r3, YearDays@ha
/* 0A895C 800ADEFC 38C3F400 */  addi    r6, r3, YearDays@l
lbl_800ADF00:
/* 0A8960 800ADF00 38E0000C */  li      r7, 0xc
/* 0A8964 800ADF04 38600030 */  li      r3, 0x30
/* 0A8968 800ADF08 48000004 */  b       lbl_800ADF0C
lbl_800ADF0C:
/* 0A896C 800ADF0C 48000004 */  b       lbl_800ADF10
lbl_800ADF10:
/* 0A8970 800ADF10 3863FFFC */  addi    r3, r3, -4
/* 0A8974 800ADF14 7CA6182E */  lwzx    r5, r6, r3
/* 0A8978 800ADF18 38E7FFFF */  addi    r7, r7, -1
/* 0A897C 800ADF1C 7C002800 */  cmpw    r0, r5
/* 0A8980 800ADF20 4180FFF0 */  blt     lbl_800ADF10
/* 0A8984 800ADF24 90E40010 */  stw     r7, 0x10(r4)
/* 0A8988 800ADF28 7C66182E */  lwzx    r3, r6, r3
/* 0A898C 800ADF2C 7C630050 */  subf    r3, r3, r0
/* 0A8990 800ADF30 38030001 */  addi    r0, r3, 1
/* 0A8994 800ADF34 9004000C */  stw     r0, 0xc(r4)
/* 0A8998 800ADF38 4E800020 */  blr     

glabel OSTicksToCalendarTime
/* 0A899C 800ADF3C 7C0802A6 */  mflr    r0
/* 0A89A0 800ADF40 90010004 */  stw     r0, 4(r1)
/* 0A89A4 800ADF44 9421FFC8 */  stwu    r1, -0x38(r1)
/* 0A89A8 800ADF48 BF21001C */  stmw    r25, 0x1c(r1)
/* 0A89AC 800ADF4C 7C7D1B78 */  mr      r29, r3
/* 0A89B0 800ADF50 7C9E2378 */  mr      r30, r4
/* 0A89B4 800ADF54 7CBF2B78 */  mr      r31, r5
/* 0A89B8 800ADF58 3F608000 */  lis     r27, 0x8000
/* 0A89BC 800ADF5C 801B00F8 */  lwz     r0, 0xf8(r27)
/* 0A89C0 800ADF60 7FA3EB78 */  mr      r3, r29
/* 0A89C4 800ADF64 7FC4F378 */  mr      r4, r30
/* 0A89C8 800ADF68 5406F0BE */  srwi    r6, r0, 2
/* 0A89CC 800ADF6C 38A00000 */  li      r5, 0
/* 0A89D0 800ADF70 4802BE55 */  bl      __mod2i
/* 0A89D4 800ADF74 7C7A1B78 */  mr      r26, r3
/* 0A89D8 800ADF78 38A00000 */  li      r5, 0
/* 0A89DC 800ADF7C 7C992378 */  mr      r25, r4
/* 0A89E0 800ADF80 6F448000 */  xoris   r4, r26, 0x8000
/* 0A89E4 800ADF84 6CA38000 */  xoris   r3, r5, 0x8000
/* 0A89E8 800ADF88 7C05C810 */  subfc   r0, r5, r25
/* 0A89EC 800ADF8C 7C632110 */  subfe   r3, r3, r4
/* 0A89F0 800ADF90 7C642110 */  subfe   r3, r4, r4
/* 0A89F4 800ADF94 7C6300D0 */  neg     r3, r3
/* 0A89F8 800ADF98 2C030000 */  cmpwi   r3, 0
/* 0A89FC 800ADF9C 41820014 */  beq     lbl_800ADFB0
/* 0A8A00 800ADFA0 801B00F8 */  lwz     r0, 0xf8(r27)
/* 0A8A04 800ADFA4 5400F0BE */  srwi    r0, r0, 2
/* 0A8A08 800ADFA8 7F390014 */  addc    r25, r25, r0
/* 0A8A0C 800ADFAC 7F5A2914 */  adde    r26, r26, r5
lbl_800ADFB0:
/* 0A8A10 800ADFB0 38800008 */  li      r4, 8
/* 0A8A14 800ADFB4 7C7A21D6 */  mullw   r3, r26, r4
/* 0A8A18 800ADFB8 7C192016 */  mulhwu  r0, r25, r4
/* 0A8A1C 800ADFBC 3F608000 */  lis     r27, 0x8000
/* 0A8A20 800ADFC0 80DB00F8 */  lwz     r6, 0xf8(r27)
/* 0A8A24 800ADFC4 3CA0431C */  lis     r5, 0x431c
/* 0A8A28 800ADFC8 38A5DE83 */  addi    r5, r5, -8573
/* 0A8A2C 800ADFCC 54C6F0BE */  srwi    r6, r6, 2
/* 0A8A30 800ADFD0 7CA53016 */  mulhwu  r5, r5, r6
/* 0A8A34 800ADFD4 54A68BFE */  srwi    r6, r5, 0xf
/* 0A8A38 800ADFD8 3B800000 */  li      r28, 0
/* 0A8A3C 800ADFDC 7C630214 */  add     r3, r3, r0
/* 0A8A40 800ADFE0 7C19E1D6 */  mullw   r0, r25, r28
/* 0A8A44 800ADFE4 7C9921D6 */  mullw   r4, r25, r4
/* 0A8A48 800ADFE8 7C630214 */  add     r3, r3, r0
/* 0A8A4C 800ADFEC 38A00000 */  li      r5, 0
/* 0A8A50 800ADFF0 4802BBB9 */  bl      __div2i
/* 0A8A54 800ADFF4 38A00000 */  li      r5, 0
/* 0A8A58 800ADFF8 38C003E8 */  li      r6, 0x3e8
/* 0A8A5C 800ADFFC 4802BDC9 */  bl      __mod2i
/* 0A8A60 800AE000 909F0024 */  stw     r4, 0x24(r31)
/* 0A8A64 800AE004 3C601062 */  lis     r3, 0x1062
/* 0A8A68 800AE008 38A34DD3 */  addi    r5, r3, 0x4dd3
/* 0A8A6C 800AE00C 801B00F8 */  lwz     r0, 0xf8(r27)
/* 0A8A70 800AE010 7F43D378 */  mr      r3, r26
/* 0A8A74 800AE014 7F24CB78 */  mr      r4, r25
/* 0A8A78 800AE018 5400F0BE */  srwi    r0, r0, 2
/* 0A8A7C 800AE01C 7C050016 */  mulhwu  r0, r5, r0
/* 0A8A80 800AE020 5406D1BE */  srwi    r6, r0, 6
/* 0A8A84 800AE024 38A00000 */  li      r5, 0
/* 0A8A88 800AE028 4802BB81 */  bl      __div2i
/* 0A8A8C 800AE02C 38A00000 */  li      r5, 0
/* 0A8A90 800AE030 38C003E8 */  li      r6, 0x3e8
/* 0A8A94 800AE034 4802BD91 */  bl      __mod2i
/* 0A8A98 800AE038 909F0020 */  stw     r4, 0x20(r31)
/* 0A8A9C 800AE03C 7FD9F010 */  subfc   r30, r25, r30
/* 0A8AA0 800AE040 7FBAE910 */  subfe   r29, r26, r29
/* 0A8AA4 800AE044 801B00F8 */  lwz     r0, 0xf8(r27)
/* 0A8AA8 800AE048 3CA00001 */  lis     r5, 1
/* 0A8AAC 800AE04C 3B255180 */  addi    r25, r5, 0x5180
/* 0A8AB0 800AE050 7FA3EB78 */  mr      r3, r29
/* 0A8AB4 800AE054 5406F0BE */  srwi    r6, r0, 2
/* 0A8AB8 800AE058 7FC4F378 */  mr      r4, r30
/* 0A8ABC 800AE05C 38A00000 */  li      r5, 0
/* 0A8AC0 800AE060 4802BB49 */  bl      __div2i
/* 0A8AC4 800AE064 7F26CB78 */  mr      r6, r25
/* 0A8AC8 800AE068 38A00000 */  li      r5, 0
/* 0A8ACC 800AE06C 4802BB3D */  bl      __div2i
/* 0A8AD0 800AE070 3CA0000B */  lis     r5, 0xb
/* 0A8AD4 800AE074 801B00F8 */  lwz     r0, 0xf8(r27)
/* 0A8AD8 800AE078 38A52575 */  addi    r5, r5, 0x2575
/* 0A8ADC 800AE07C 7F442814 */  addc    r26, r4, r5
/* 0A8AE0 800AE080 5406F0BE */  srwi    r6, r0, 2
/* 0A8AE4 800AE084 7C03E114 */  adde    r0, r3, r28
/* 0A8AE8 800AE088 7FA3EB78 */  mr      r3, r29
/* 0A8AEC 800AE08C 7FC4F378 */  mr      r4, r30
/* 0A8AF0 800AE090 38A00000 */  li      r5, 0
/* 0A8AF4 800AE094 4802BB15 */  bl      __div2i
/* 0A8AF8 800AE098 7F26CB78 */  mr      r6, r25
/* 0A8AFC 800AE09C 38A00000 */  li      r5, 0
/* 0A8B00 800AE0A0 4802BD25 */  bl      __mod2i
/* 0A8B04 800AE0A4 7C9B2378 */  mr      r27, r4
/* 0A8B08 800AE0A8 2C1B0000 */  cmpwi   r27, 0
/* 0A8B0C 800AE0AC 40800010 */  bge     lbl_800AE0BC
/* 0A8B10 800AE0B0 3F7B0001 */  addis   r27, r27, 1
/* 0A8B14 800AE0B4 3B5AFFFF */  addi    r26, r26, -1
/* 0A8B18 800AE0B8 3B7B5180 */  addi    r27, r27, 0x5180
lbl_800AE0BC:
/* 0A8B1C 800AE0BC 7F43D378 */  mr      r3, r26
/* 0A8B20 800AE0C0 7FE4FB78 */  mr      r4, r31
/* 0A8B24 800AE0C4 4BFFFCDD */  bl      GetDates
/* 0A8B28 800AE0C8 3C608889 */  lis     r3, 0x8889
/* 0A8B2C 800AE0CC 38A38889 */  addi    r5, r3, -30583
/* 0A8B30 800AE0D0 7C05D896 */  mulhw   r0, r5, r27
/* 0A8B34 800AE0D4 7C80DA14 */  add     r4, r0, r27
/* 0A8B38 800AE0D8 7C802E70 */  srawi   r0, r4, 5
/* 0A8B3C 800AE0DC 54030FFE */  srwi    r3, r0, 0x1f
/* 0A8B40 800AE0E0 7CE01A14 */  add     r7, r0, r3
/* 0A8B44 800AE0E4 7C053896 */  mulhw   r0, r5, r7
/* 0A8B48 800AE0E8 7C003A14 */  add     r0, r0, r7
/* 0A8B4C 800AE0EC 7C052E70 */  srawi   r5, r0, 5
/* 0A8B50 800AE0F0 7C002E70 */  srawi   r0, r0, 5
/* 0A8B54 800AE0F4 54030FFE */  srwi    r3, r0, 0x1f
/* 0A8B58 800AE0F8 7C601A14 */  add     r3, r0, r3
/* 0A8B5C 800AE0FC 7C802E70 */  srawi   r0, r4, 5
/* 0A8B60 800AE100 54A60FFE */  srwi    r6, r5, 0x1f
/* 0A8B64 800AE104 1C83003C */  mulli   r4, r3, 0x3c
/* 0A8B68 800AE108 54030FFE */  srwi    r3, r0, 0x1f
/* 0A8B6C 800AE10C 7CA53214 */  add     r5, r5, r6
/* 0A8B70 800AE110 7C001A14 */  add     r0, r0, r3
/* 0A8B74 800AE114 90BF0008 */  stw     r5, 8(r31)
/* 0A8B78 800AE118 1C00003C */  mulli   r0, r0, 0x3c
/* 0A8B7C 800AE11C 7C643850 */  subf    r3, r4, r7
/* 0A8B80 800AE120 907F0004 */  stw     r3, 4(r31)
/* 0A8B84 800AE124 7C00D850 */  subf    r0, r0, r27
/* 0A8B88 800AE128 901F0000 */  stw     r0, 0(r31)
/* 0A8B8C 800AE12C BB21001C */  lmw     r25, 0x1c(r1)
/* 0A8B90 800AE130 8001003C */  lwz     r0, 0x3c(r1)
/* 0A8B94 800AE134 38210038 */  addi    r1, r1, 0x38
/* 0A8B98 800AE138 7C0803A6 */  mtlr    r0
/* 0A8B9C 800AE13C 4E800020 */  blr     


.section .data, "wa"

.balign 8

/* 000FC480 800FF400 0030 */
YearDays:
    .long 0x00000000, 0x0000001F, 0x0000003B, 0x0000005A, 0x00000078, 0x00000097, 0x000000B5, 0x000000D4
    .long 0x000000F3, 0x00000111, 0x00000130, 0x0000014E

.balign 4

/* 000FC4B0 800FF430 0030 */
LeapYearDays:
    .long 0x00000000, 0x0000001F, 0x0000003C, 0x0000005B, 0x00000079, 0x00000098, 0x000000B6, 0x000000D5
    .long 0x000000F4, 0x00000112, 0x00000131, 0x0000014F


