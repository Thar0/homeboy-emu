# OSReset.c
.include "macros.inc"

.section .text, "ax"

.balign 4

glabel OSRegisterResetFunction
/* 0A62FC 800AB89C 80AD9140 */  lwz		r5, ResetFunctionQueue-_SDA_BASE_(r13)
/* 0A6300 800AB8A0 48000008 */  b		lbl_800AB8A8
lbl_800AB8A4:
/* 0A6304 800AB8A4 80A50008 */  lwz		r5, 8(r5)
lbl_800AB8A8:
/* 0A6308 800AB8A8 28050000 */  cmplwi	r5, 0
/* 0A630C 800AB8AC 41820014 */  beq		lbl_800AB8C0
/* 0A6310 800AB8B0 80850004 */  lwz		r4, 4(r5)
/* 0A6314 800AB8B4 80030004 */  lwz		r0, 4(r3)
/* 0A6318 800AB8B8 7C040040 */  cmplw	r4, r0
/* 0A631C 800AB8BC 4081FFE8 */  ble		lbl_800AB8A4
lbl_800AB8C0:
/* 0A6320 800AB8C0 28050000 */  cmplwi	r5, 0
/* 0A6324 800AB8C4 40820034 */  bne		lbl_800AB8F8
/* 0A6328 800AB8C8 38AD9140 */  addi	r5, r13, ResetFunctionQueue-_SDA_BASE_
/* 0A632C 800AB8CC 84850004 */  lwzu	r4, 4(r5)
/* 0A6330 800AB8D0 28040000 */  cmplwi	r4, 0
/* 0A6334 800AB8D4 4082000C */  bne		lbl_800AB8E0
/* 0A6338 800AB8D8 906D9140 */  stw		r3, ResetFunctionQueue-_SDA_BASE_(r13)
/* 0A633C 800AB8DC 48000008 */  b		lbl_800AB8E4
lbl_800AB8E0:
/* 0A6340 800AB8E0 90640008 */  stw		r3, 8(r4)
lbl_800AB8E4:
/* 0A6344 800AB8E4 9083000C */  stw		r4, 0xc(r3)
/* 0A6348 800AB8E8 38000000 */  li		r0, 0
/* 0A634C 800AB8EC 90030008 */  stw		r0, 8(r3)
/* 0A6350 800AB8F0 90650000 */  stw		r3, 0(r5)
/* 0A6354 800AB8F4 4E800020 */  blr		
lbl_800AB8F8:
/* 0A6358 800AB8F8 90A30008 */  stw		r5, 8(r3)
/* 0A635C 800AB8FC 8085000C */  lwz		r4, 0xc(r5)
/* 0A6360 800AB900 9065000C */  stw		r3, 0xc(r5)
/* 0A6364 800AB904 28040000 */  cmplwi	r4, 0
/* 0A6368 800AB908 9083000C */  stw		r4, 0xc(r3)
/* 0A636C 800AB90C 4082000C */  bne		lbl_800AB918
/* 0A6370 800AB910 906D9140 */  stw		r3, ResetFunctionQueue-_SDA_BASE_(r13)
/* 0A6374 800AB914 4E800020 */  blr		
lbl_800AB918:
/* 0A6378 800AB918 90640008 */  stw		r3, 8(r4)
/* 0A637C 800AB91C 4E800020 */  blr		

Reset:
/* 0A6380 800AB920 48000020 */  b		lbl_800AB940
lbl_800AB924:
/* 0A6384 800AB924 7D10FAA6 */  mfspr	r8, 0x3f0
/* 0A6388 800AB928 61080008 */  ori		r8, r8, 8
/* 0A638C 800AB92C 7D10FBA6 */  mtspr	0x3f0, r8
/* 0A6390 800AB930 4C00012C */  isync	
/* 0A6394 800AB934 7C0004AC */  sync	0
/* 0A6398 800AB938 60000000 */  nop		
/* 0A639C 800AB93C 48000008 */  b		lbl_800AB944
lbl_800AB940:
/* 0A63A0 800AB940 48000020 */  b		lbl_800AB960
lbl_800AB944:
/* 0A63A4 800AB944 7CAC42E6 */  mftb	r5, 0x10c
lbl_800AB948:
/* 0A63A8 800AB948 7CCC42E6 */  mftb	r6, 0x10c
/* 0A63AC 800AB94C 7CE53050 */  subf	r7, r5, r6
/* 0A63B0 800AB950 28071124 */  cmplwi	r7, 0x1124
/* 0A63B4 800AB954 4180FFF4 */  blt		lbl_800AB948
/* 0A63B8 800AB958 60000000 */  nop		
/* 0A63BC 800AB95C 48000008 */  b		lbl_800AB964
lbl_800AB960:
/* 0A63C0 800AB960 48000020 */  b		lbl_800AB980
lbl_800AB964:
/* 0A63C4 800AB964 3D00CC00 */  lis		r8, 0xcc00
/* 0A63C8 800AB968 61083000 */  ori		r8, r8, 0x3000
/* 0A63CC 800AB96C 38800003 */  li		r4, 3
/* 0A63D0 800AB970 90880024 */  stw		r4, 0x24(r8)
/* 0A63D4 800AB974 90680024 */  stw		r3, 0x24(r8)
/* 0A63D8 800AB978 60000000 */  nop		
/* 0A63DC 800AB97C 48000008 */  b		lbl_800AB984
lbl_800AB980:
/* 0A63E0 800AB980 4800000C */  b		lbl_800AB98C
lbl_800AB984:
/* 0A63E4 800AB984 60000000 */  nop		
/* 0A63E8 800AB988 4BFFFFFC */  b		lbl_800AB984
lbl_800AB98C:
/* 0A63EC 800AB98C 4BFFFF98 */  b		lbl_800AB924

glabel __OSDoHotReset
/* 0A63F0 800AB990 7C0802A6 */  mflr	r0
/* 0A63F4 800AB994 90010004 */  stw		r0, 4(r1)
/* 0A63F8 800AB998 9421FFE8 */  stwu	r1, -0x18(r1)
/* 0A63FC 800AB99C 93E10014 */  stw		r31, 0x14(r1)
/* 0A6400 800AB9A0 7C7F1B78 */  mr		r31, r3
/* 0A6404 800AB9A4 4BFFEDCD */  bl		OSDisableInterrupts
/* 0A6408 800AB9A8 3C60CC00 */  lis		r3, 0xcc00
/* 0A640C 800AB9AC 38632000 */  addi	r3, r3, 0x2000
/* 0A6410 800AB9B0 38000000 */  li		r0, 0
/* 0A6414 800AB9B4 B0030002 */  sth		r0, 2(r3)
/* 0A6418 800AB9B8 4BFFD925 */  bl		ICFlashInvalidate
/* 0A641C 800AB9BC 57E31838 */  slwi	r3, r31, 3
/* 0A6420 800AB9C0 4BFFFF61 */  bl		Reset
/* 0A6424 800AB9C4 8001001C */  lwz		r0, 0x1c(r1)
/* 0A6428 800AB9C8 83E10014 */  lwz		r31, 0x14(r1)
/* 0A642C 800AB9CC 38210018 */  addi	r1, r1, 0x18
/* 0A6430 800AB9D0 7C0803A6 */  mtlr	r0
/* 0A6434 800AB9D4 4E800020 */  blr		

glabel OSResetSystem
/* 0A6438 800AB9D8 7C0802A6 */  mflr	r0
/* 0A643C 800AB9DC 90010004 */  stw		r0, 4(r1)
/* 0A6440 800AB9E0 9421FFC0 */  stwu	r1, -0x40(r1)
/* 0A6444 800AB9E4 BF410028 */  stmw	r26, 0x28(r1)
/* 0A6448 800AB9E8 7C7C1B78 */  mr		r28, r3
/* 0A644C 800AB9EC 7C9D2378 */  mr		r29, r4
/* 0A6450 800AB9F0 7CBE2B78 */  mr		r30, r5
/* 0A6454 800AB9F4 480012D1 */  bl		OSDisableScheduler
/* 0A6458 800AB9F8 4BFFD6E1 */  bl		__OSStopAudioSystem
/* 0A645C 800AB9FC 2C1C0002 */  cmpwi	r28, 2
/* 0A6460 800ABA00 41820018 */  beq		lbl_800ABA18
/* 0A6464 800ABA04 2C1C0000 */  cmpwi	r28, 0
/* 0A6468 800ABA08 4082001C */  bne		lbl_800ABA24
/* 0A646C 800ABA0C 800D9148 */  lwz		r0, bootThisDol-_SDA_BASE_(r13)
/* 0A6470 800ABA10 28000000 */  cmplwi	r0, 0
/* 0A6474 800ABA14 41820010 */  beq		lbl_800ABA24
lbl_800ABA18:
/* 0A6478 800ABA18 38600001 */  li		r3, 1
/* 0A647C 800ABA1C 4801189D */  bl		__PADDisableRecalibration
/* 0A6480 800ABA20 7C7F1B78 */  mr		r31, r3
lbl_800ABA24:
/* 0A6484 800ABA24 48000004 */  b		lbl_800ABA28
lbl_800ABA28:
/* 0A6488 800ABA28 48000004 */  b		lbl_800ABA2C
lbl_800ABA2C:
/* 0A648C 800ABA2C 834D9140 */  lwz		r26, ResetFunctionQueue-_SDA_BASE_(r13)
/* 0A6490 800ABA30 3B600000 */  li		r27, 0
/* 0A6494 800ABA34 48000004 */  b		lbl_800ABA38
lbl_800ABA38:
/* 0A6498 800ABA38 48000004 */  b		lbl_800ABA3C
lbl_800ABA3C:
/* 0A649C 800ABA3C 48000024 */  b		lbl_800ABA60
lbl_800ABA40:
/* 0A64A0 800ABA40 38600000 */  li		r3, 0
/* 0A64A4 800ABA44 819A0000 */  lwz		r12, 0(r26)
/* 0A64A8 800ABA48 7D8803A6 */  mtlr	r12
/* 0A64AC 800ABA4C 4E800021 */  blrl	
/* 0A64B0 800ABA50 7C600034 */  cntlzw	r0, r3
/* 0A64B4 800ABA54 835A0008 */  lwz		r26, 8(r26)
/* 0A64B8 800ABA58 5400D97E */  srwi	r0, r0, 5
/* 0A64BC 800ABA5C 7F7B0378 */  or		r27, r27, r0
lbl_800ABA60:
/* 0A64C0 800ABA60 281A0000 */  cmplwi	r26, 0
/* 0A64C4 800ABA64 4182000C */  beq		lbl_800ABA70
/* 0A64C8 800ABA68 2C1B0000 */  cmpwi	r27, 0
/* 0A64CC 800ABA6C 4182FFD4 */  beq		lbl_800ABA40
lbl_800ABA70:
/* 0A64D0 800ABA70 48000CCD */  bl		__OSSyncSram
/* 0A64D4 800ABA74 7C600034 */  cntlzw	r0, r3
/* 0A64D8 800ABA78 5400D97E */  srwi	r0, r0, 5
/* 0A64DC 800ABA7C 7F7B0378 */  or		r27, r27, r0
/* 0A64E0 800ABA80 2C1B0000 */  cmpwi	r27, 0
/* 0A64E4 800ABA84 4182000C */  beq		lbl_800ABA90
/* 0A64E8 800ABA88 38000000 */  li		r0, 0
/* 0A64EC 800ABA8C 48000008 */  b		lbl_800ABA94
lbl_800ABA90:
/* 0A64F0 800ABA90 38000001 */  li		r0, 1
lbl_800ABA94:
/* 0A64F4 800ABA94 2C000000 */  cmpwi	r0, 0
/* 0A64F8 800ABA98 4182FF94 */  beq		lbl_800ABA2C
/* 0A64FC 800ABA9C 2C1C0001 */  cmpwi	r28, 1
/* 0A6500 800ABAA0 40820038 */  bne		lbl_800ABAD8
/* 0A6504 800ABAA4 2C1E0000 */  cmpwi	r30, 0
/* 0A6508 800ABAA8 41820030 */  beq		lbl_800ABAD8
/* 0A650C 800ABAAC 48000855 */  bl		__OSLockSram
/* 0A6510 800ABAB0 88030013 */  lbz		r0, 0x13(r3)
/* 0A6514 800ABAB4 60000040 */  ori		r0, r0, 0x40
/* 0A6518 800ABAB8 98030013 */  stb		r0, 0x13(r3)
/* 0A651C 800ABABC 38600001 */  li		r3, 1
/* 0A6520 800ABAC0 48000C35 */  bl		__OSUnlockSram
/* 0A6524 800ABAC4 48000004 */  b		lbl_800ABAC8
lbl_800ABAC8:
/* 0A6528 800ABAC8 48000004 */  b		lbl_800ABACC
lbl_800ABACC:
/* 0A652C 800ABACC 48000C71 */  bl		__OSSyncSram
/* 0A6530 800ABAD0 2C030000 */  cmpwi	r3, 0
/* 0A6534 800ABAD4 4182FFF8 */  beq		lbl_800ABACC
lbl_800ABAD8:
/* 0A6538 800ABAD8 4BFFEC99 */  bl		OSDisableInterrupts
/* 0A653C 800ABADC 836D9140 */  lwz		r27, ResetFunctionQueue-_SDA_BASE_(r13)
/* 0A6540 800ABAE0 3B400000 */  li		r26, 0
/* 0A6544 800ABAE4 48000004 */  b		lbl_800ABAE8
lbl_800ABAE8:
/* 0A6548 800ABAE8 48000004 */  b		lbl_800ABAEC
lbl_800ABAEC:
/* 0A654C 800ABAEC 48000024 */  b		lbl_800ABB10
lbl_800ABAF0:
/* 0A6550 800ABAF0 38600001 */  li		r3, 1
/* 0A6554 800ABAF4 819B0000 */  lwz		r12, 0(r27)
/* 0A6558 800ABAF8 7D8803A6 */  mtlr	r12
/* 0A655C 800ABAFC 4E800021 */  blrl	
/* 0A6560 800ABB00 7C600034 */  cntlzw	r0, r3
/* 0A6564 800ABB04 837B0008 */  lwz		r27, 8(r27)
/* 0A6568 800ABB08 5400D97E */  srwi	r0, r0, 5
/* 0A656C 800ABB0C 7F5A0378 */  or		r26, r26, r0
lbl_800ABB10:
/* 0A6570 800ABB10 281B0000 */  cmplwi	r27, 0
/* 0A6574 800ABB14 4182000C */  beq		lbl_800ABB20
/* 0A6578 800ABB18 2C1A0000 */  cmpwi	r26, 0
/* 0A657C 800ABB1C 4182FFD4 */  beq		lbl_800ABAF0
lbl_800ABB20:
/* 0A6580 800ABB20 48000C1D */  bl		__OSSyncSram
/* 0A6584 800ABB24 4BFFD8E1 */  bl		LCDisable
/* 0A6588 800ABB28 2C1C0001 */  cmpwi	r28, 1
/* 0A658C 800ABB2C 40820028 */  bne		lbl_800ABB54
/* 0A6590 800ABB30 4BFFEC41 */  bl		OSDisableInterrupts
/* 0A6594 800ABB34 3C60CC00 */  lis		r3, 0xcc00
/* 0A6598 800ABB38 38632000 */  addi	r3, r3, 0x2000
/* 0A659C 800ABB3C 38000000 */  li		r0, 0
/* 0A65A0 800ABB40 B0030002 */  sth		r0, 2(r3)
/* 0A65A4 800ABB44 4BFFD799 */  bl		ICFlashInvalidate
/* 0A65A8 800ABB48 57A31838 */  slwi	r3, r29, 3
/* 0A65AC 800ABB4C 4BFFFDD5 */  bl		Reset
/* 0A65B0 800ABB50 4800007C */  b		lbl_800ABBCC
lbl_800ABB54:
/* 0A65B4 800ABB54 2C1C0000 */  cmpwi	r28, 0
/* 0A65B8 800ABB58 40820074 */  bne		lbl_800ABBCC
/* 0A65BC 800ABB5C 800D9148 */  lwz		r0, bootThisDol-_SDA_BASE_(r13)
/* 0A65C0 800ABB60 3C608000 */  lis		r3, 0x8000
/* 0A65C4 800ABB64 28000000 */  cmplwi	r0, 0
/* 0A65C8 800ABB68 900330EC */  stw		r0, 0x30ec(r3)
/* 0A65CC 800ABB6C 4182000C */  beq		lbl_800ABB78
/* 0A65D0 800ABB70 7FE3FB78 */  mr		r3, r31
/* 0A65D4 800ABB74 48011745 */  bl		__PADDisableRecalibration
lbl_800ABB78:
/* 0A65D8 800ABB78 3C608000 */  lis		r3, 0x8000
/* 0A65DC 800ABB7C 806300DC */  lwz		r3, 0xdc(r3)
/* 0A65E0 800ABB80 48000004 */  b		lbl_800ABB84
lbl_800ABB84:
/* 0A65E4 800ABB84 48000004 */  b		lbl_800ABB88
lbl_800ABB88:
/* 0A65E8 800ABB88 4800002C */  b		lbl_800ABBB4
lbl_800ABB8C:
/* 0A65EC 800ABB8C A00302C8 */  lhz		r0, 0x2c8(r3)
/* 0A65F0 800ABB90 834302FC */  lwz		r26, 0x2fc(r3)
/* 0A65F4 800ABB94 2C000004 */  cmpwi	r0, 4
/* 0A65F8 800ABB98 41820014 */  beq		lbl_800ABBAC
/* 0A65FC 800ABB9C 40800014 */  bge		lbl_800ABBB0
/* 0A6600 800ABBA0 2C000001 */  cmpwi	r0, 1
/* 0A6604 800ABBA4 41820008 */  beq		lbl_800ABBAC
/* 0A6608 800ABBA8 48000008 */  b		lbl_800ABBB0
lbl_800ABBAC:
/* 0A660C 800ABBAC 48001921 */  bl		OSCancelThread
lbl_800ABBB0:
/* 0A6610 800ABBB0 7F43D378 */  mr		r3, r26
lbl_800ABBB4:
/* 0A6614 800ABBB4 28030000 */  cmplwi	r3, 0
/* 0A6618 800ABBB8 4082FFD4 */  bne		lbl_800ABB8C
/* 0A661C 800ABBBC 48001149 */  bl		OSEnableScheduler
/* 0A6620 800ABBC0 7FA3EB78 */  mr		r3, r29
/* 0A6624 800ABBC4 7FC4F378 */  mr		r4, r30
/* 0A6628 800ABBC8 4BFFF995 */  bl		__OSReboot
lbl_800ABBCC:
/* 0A662C 800ABBCC 3C608000 */  lis		r3, 0x8000
/* 0A6630 800ABBD0 806300DC */  lwz		r3, 0xdc(r3)
/* 0A6634 800ABBD4 48000004 */  b		lbl_800ABBD8
lbl_800ABBD8:
/* 0A6638 800ABBD8 48000004 */  b		lbl_800ABBDC
lbl_800ABBDC:
/* 0A663C 800ABBDC 4800002C */  b		lbl_800ABC08
lbl_800ABBE0:
/* 0A6640 800ABBE0 A00302C8 */  lhz		r0, 0x2c8(r3)
/* 0A6644 800ABBE4 834302FC */  lwz		r26, 0x2fc(r3)
/* 0A6648 800ABBE8 2C000004 */  cmpwi	r0, 4
/* 0A664C 800ABBEC 41820014 */  beq		lbl_800ABC00
/* 0A6650 800ABBF0 40800014 */  bge		lbl_800ABC04
/* 0A6654 800ABBF4 2C000001 */  cmpwi	r0, 1
/* 0A6658 800ABBF8 41820008 */  beq		lbl_800ABC00
/* 0A665C 800ABBFC 48000008 */  b		lbl_800ABC04
lbl_800ABC00:
/* 0A6660 800ABC00 480018CD */  bl		OSCancelThread
lbl_800ABC04:
/* 0A6664 800ABC04 7F43D378 */  mr		r3, r26
lbl_800ABC08:
/* 0A6668 800ABC08 28030000 */  cmplwi	r3, 0
/* 0A666C 800ABC0C 4082FFD4 */  bne		lbl_800ABBE0
/* 0A6670 800ABC10 3F808000 */  lis		r28, 0x8000
/* 0A6674 800ABC14 387C0040 */  addi	r3, r28, 0x40
/* 0A6678 800ABC18 38800000 */  li		r4, 0
/* 0A667C 800ABC1C 38A0008C */  li		r5, 0x8c
/* 0A6680 800ABC20 4BF597B1 */  bl		memset
/* 0A6684 800ABC24 387C00D4 */  addi	r3, r28, 0xd4
/* 0A6688 800ABC28 38800000 */  li		r4, 0
/* 0A668C 800ABC2C 38A00014 */  li		r5, 0x14
/* 0A6690 800ABC30 4BF597A1 */  bl		memset
/* 0A6694 800ABC34 387C00F4 */  addi	r3, r28, 0xf4
/* 0A6698 800ABC38 38800000 */  li		r4, 0
/* 0A669C 800ABC3C 38A00004 */  li		r5, 4
/* 0A66A0 800ABC40 4BF59791 */  bl		memset
/* 0A66A4 800ABC44 387C3000 */  addi	r3, r28, 0x3000
/* 0A66A8 800ABC48 38800000 */  li		r4, 0
/* 0A66AC 800ABC4C 38A000C0 */  li		r5, 0xc0
/* 0A66B0 800ABC50 4BF59781 */  bl		memset
/* 0A66B4 800ABC54 387C30C8 */  addi	r3, r28, 0x30c8
/* 0A66B8 800ABC58 38800000 */  li		r4, 0
/* 0A66BC 800ABC5C 38A0000C */  li		r5, 0xc
/* 0A66C0 800ABC60 4BF59771 */  bl		memset
/* 0A66C4 800ABC64 387C30E2 */  addi	r3, r28, 0x30e2
/* 0A66C8 800ABC68 38800000 */  li		r4, 0
/* 0A66CC 800ABC6C 38A00001 */  li		r5, 1
/* 0A66D0 800ABC70 4BF59761 */  bl		memset
/* 0A66D4 800ABC74 7FE3FB78 */  mr		r3, r31
/* 0A66D8 800ABC78 48011641 */  bl		__PADDisableRecalibration
/* 0A66DC 800ABC7C BB410028 */  lmw		r26, 0x28(r1)
/* 0A66E0 800ABC80 80010044 */  lwz		r0, 0x44(r1)
/* 0A66E4 800ABC84 38210040 */  addi	r1, r1, 0x40
/* 0A66E8 800ABC88 7C0803A6 */  mtlr	r0
/* 0A66EC 800ABC8C 4E800020 */  blr		

glabel OSGetResetCode
/* 0A66F0 800ABC90 3C608000 */  lis		r3, 0x8000
/* 0A66F4 800ABC94 880330E2 */  lbz		r0, 0x30e2(r3)
/* 0A66F8 800ABC98 28000000 */  cmplwi	r0, 0
/* 0A66FC 800ABC9C 4182000C */  beq		lbl_800ABCA8
/* 0A6700 800ABCA0 3C608000 */  lis		r3, 0x8000
/* 0A6704 800ABCA4 48000018 */  b		lbl_800ABCBC
lbl_800ABCA8:
/* 0A6708 800ABCA8 3C60CC00 */  lis		r3, 0xcc00
/* 0A670C 800ABCAC 38633000 */  addi	r3, r3, 0x3000
/* 0A6710 800ABCB0 80030024 */  lwz		r0, 0x24(r3)
/* 0A6714 800ABCB4 54000038 */  rlwinm	r0, r0, 0, 0, 0x1c
/* 0A6718 800ABCB8 5403E8FE */  srwi	r3, r0, 3
lbl_800ABCBC:
/* 0A671C 800ABCBC 4E800020 */  blr		


.section .sbss, "wa"

.balign 8

/* 00100380 80145B20 0008 */
ResetFunctionQueue:
    .skip 8

.balign 4

/* 00100388 80145B28 0004 */
bootThisDol:
    .skip 4


